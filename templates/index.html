<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard BI - Plano Patrimonial Ana | CIMO Multi Family Office</title>
    
    <!-- Chart.js + jsPDF com fallbacks -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js" onerror="loadJsPDFFallback()"></script>
    <script>
        function loadJsPDFFallback() {
            console.log('Tentando jsPDF fallback...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = () => {
                console.log('jsPDF fallback carregado');
                setTimeout(checkLibraries, 100);
            };
            script.onerror = () => {
                console.log('Todos os CDNs do jsPDF falharam');
                setTimeout(checkLibraries, 100);
            };
            document.head.appendChild(script);
        }
    </script>
    
    <!-- Outras dependências -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ================ CSS VARIABLES ================ */
:root {
    /* Cores principais */
    --primary-dark: #1e293b;
    --primary-medium: #334155;
    --primary-light: #475569;
    --primary-darker: #0f172a;
    --primary-darkest: #020617;
    
    /* Cores de destaque */
    --accent-blue: #0ea5e9;
    --accent-blue-dark: #0284c7;
    --accent-green: #059669;
    --accent-green-dark: #047857;
    --accent-orange: #d97706;
    --accent-red: #dc2626;
    --accent-purple: #7c3aed;
    
    /* Cores neutras */
    --white: #ffffff;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
    
    /* Elementos de interface */
    --bg-card: rgba(30, 41, 59, 0.6);
    --bg-card-hover: rgba(30, 41, 59, 0.8);
    --border-color: rgba(148, 163, 184, 0.2);
    --border-color-hover: rgba(148, 163, 184, 0.4);
    
    /* Sombras aprimoradas */
    --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
    --shadow-xl: 0 16px 40px rgba(0, 0, 0, 0.25);
    --shadow-2xl: 0 24px 60px rgba(0, 0, 0, 0.3);
    
    /* Transições aprimoradas */
    --transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    --transition-fast: all 0.15s cubic-bezier(0.4, 0.0, 0.2, 1);
    --transition-slow: all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    --transition-bounce: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    
    /* Sidebar */
    --sidebar-width: 280px;
    --sidebar-collapsed-width: 64px;
}

/* ================ RESET E BASE ================ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
    font-size: 16px;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, var(--primary-darkest) 0%, var(--primary-darker) 30%, var(--primary-dark) 100%);
    color: var(--white);
    min-height: 100vh;
    overflow-x: hidden;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* ================ SIDEBAR APRIMORADA ================ */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: var(--sidebar-width);
    height: 100vh;
    background: linear-gradient(180deg, var(--primary-darker) 0%, var(--primary-darkest) 100%);
    backdrop-filter: blur(20px);
    border-right: 1px solid var(--border-color);
    z-index: 1000;
    transition: width var(--transition-slow), transform var(--transition-slow);
    overflow: hidden;
    box-shadow: var(--shadow-xl);
}

.sidebar.collapsed {
    width: var(--sidebar-collapsed-width);
}

.sidebar-header {
    padding: 30px 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(15, 23, 42, 0.3);
    transition: var(--transition);
    overflow: hidden;
}

.sidebar.collapsed .sidebar-header {
    padding: 20px 12px;
    text-align: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.5em;
    font-weight: 800;
    color: var(--accent-blue);
    text-decoration: none;
    transition: var(--transition-bounce);
    white-space: nowrap;
}

.sidebar.collapsed .logo {
    justify-content: center;
    gap: 0;
    transform: scale(0.8);
}

.logo:hover {
    color: var(--white);
    transform: scale(1.05);
}

.sidebar.collapsed .logo:hover {
    transform: scale(0.9);
}

.logo-text {
    transition: var(--transition);
}

.sidebar.collapsed .logo-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
}

.logo i {
    font-size: 1.6em;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.nav-menu {
    padding: 20px 0;
    overflow-y: auto;
    height: calc(100vh - 140px);
}

.nav-section {
    margin-bottom: 30px;
}

.nav-section-title {
    padding: 0 24px 10px;
    font-size: 0.8em;
    color: var(--gray-400);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
    transition: var(--transition);
    white-space: nowrap;
    overflow: hidden;
}

.sidebar.collapsed .nav-section-title {
    opacity: 0;
    height: 0;
    padding: 0;
    margin: 0;
}

.nav-item {
    display: flex;
    align-items: center;
    padding: 16px 24px;
    color: var(--gray-300);
    text-decoration: none;
    transition: var(--transition-bounce);
    border-left: 3px solid transparent;
    position: relative;
    overflow: hidden;
    white-space: nowrap;
    margin: 4px 8px;
    border-radius: 12px;
}

.sidebar.collapsed .nav-item {
    padding: 16px;
    justify-content: center;
    margin: 8px 12px;
}

.nav-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
    transition: width var(--transition);
    z-index: -1;
    border-radius: inherit;
}

.nav-item:hover, .nav-item.active {
    color: var(--white);
    background: rgba(14, 165, 233, 0.15);
    border-left-color: var(--accent-blue);
    transform: translateX(4px) scale(1.02);
    box-shadow: var(--shadow);
}

.sidebar.collapsed .nav-item:hover, 
.sidebar.collapsed .nav-item.active {
    transform: scale(1.1);
}

.nav-item:hover::before, .nav-item.active::before {
    width: 4px;
}

.nav-item i {
    width: 24px;
    margin-right: 16px;
    font-size: 1.1em;
    transition: var(--transition);
    text-align: center;
}

.sidebar.collapsed .nav-item i {
    margin-right: 0;
}

.nav-item-text {
    transition: var(--transition);
    flex: 1;
}

.sidebar.collapsed .nav-item-text {
    opacity: 0;
    width: 0;
    overflow: hidden;
}

.nav-item .badge {
    margin-left: auto;
    background: var(--accent-orange);
    color: var(--white);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;
    transition: var(--transition);
    min-width: 20px;
    text-align: center;
}

.sidebar.collapsed .nav-item .badge {
    opacity: 0;
    width: 0;
    padding: 0;
    overflow: hidden;
}

/* Tooltip para sidebar colapsada */
.nav-item-tooltip {
    position: absolute;
    left: calc(100% + 12px);
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary-dark);
    color: var(--white);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.875em;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: var(--transition);
    z-index: 1001;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border-color);
}

.sidebar.collapsed .nav-item:hover .nav-item-tooltip {
    opacity: 1;
}

/* ================ MAIN CONTENT APRIMORADO ================ */
.main-content {
    margin-left: var(--sidebar-width);
    min-height: 100vh;
    transition: margin-left var(--transition-slow);
    position: relative;
}

.main-content.expanded {
    margin-left: var(--sidebar-collapsed-width);
}

/* ================ TOP BAR APRIMORADA ================ */
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 32px;
    background: rgba(15, 23, 42, 0.8);
    backdrop-filter: blur(30px);
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
}

.top-bar:hover {
    background: rgba(15, 23, 42, 0.9);
}

.top-bar-left {
    display: flex;
    align-items: center;
    gap: 24px;
}

.toggle-sidebar {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--white);
    font-size: 1.2em;
    cursor: pointer;
    padding: 12px;
    border-radius: 12px;
    transition: var(--transition-bounce);
    position: relative;
    overflow: hidden;
}

.toggle-sidebar::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: radial-gradient(circle, var(--accent-blue) 0%, transparent 70%);
    transition: var(--transition);
    transform: translate(-50%, -50%);
    opacity: 0;
}

.toggle-sidebar:hover {
    background: var(--bg-card-hover);
    border-color: var(--accent-blue);
    transform: scale(1.1) rotate(180deg);
    box-shadow: var(--shadow);
}

.toggle-sidebar:hover::before {
    width: 40px;
    height: 40px;
    opacity: 0.1;
}

.toggle-sidebar:active {
    transform: scale(0.95) rotate(180deg);
}

.page-header h1 {
    font-size: 2em;
    font-weight: 800;
    color: var(--white);
    margin-bottom: 4px;
    background: linear-gradient(135deg, var(--white), var(--accent-blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleShine 3s ease-in-out infinite;
}

@keyframes titleShine {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.page-header p {
    color: var(--gray-400);
    font-size: 0.95em;
    font-weight: 500;
    animation: fadeInUp 0.6s ease-out 0.2s both;
}

.top-bar-right {
    display: flex;
    align-items: center;
    gap: 16px;
}

.refresh-btn {
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark));
    border: none;
    color: var(--white);
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition-bounce);
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.refresh-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.refresh-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow-xl);
    background: linear-gradient(135deg, var(--accent-blue-dark), var(--accent-blue));
}

.refresh-btn:hover::before {
    left: 100%;
}

.refresh-btn:active {
    transform: translateY(0) scale(1);
}

.refresh-btn.loading {
    opacity: 0.8;
    cursor: not-allowed;
    animation: pulse 1.5s ease-in-out infinite;
}

.refresh-btn.loading i {
    animation: spin 1s linear infinite;
}

/* ================ CONTROLS APRIMORADOS ================ */
.controls-bar {
    background: rgba(15, 23, 42, 0.6);
    border-bottom: 1px solid var(--border-color);
    padding: 20px 32px;
    backdrop-filter: blur(20px);
    transition: var(--transition);
}

.controls-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    max-width: 1000px;
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
}

.control-group label {
    font-size: 0.85em;
    color: var(--gray-300);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: var(--transition);
}

.control-group:hover label {
    color: var(--accent-blue);
}

.control-group input,
.control-group select {
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-card);
    color: var(--white);
    font-size: 14px;
    transition: var(--transition-bounce);
    font-family: inherit;
    position: relative;
}

.control-group input:focus,
.control-group select:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2);
    background: var(--bg-card-hover);
    transform: scale(1.02);
}

.range-container {
    position: relative;
}

.range-input {
    width: 100%;
    height: 8px;
    background: var(--gray-700);
    border-radius: 4px;
    outline: none;
    -webkit-appearance: none;
    position: relative;
    transition: var(--transition);
}

.range-input:hover {
    background: var(--gray-600);
}

.range-input::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
    transition: var(--transition-bounce);
    border: 2px solid white;
}

.range-input::-webkit-slider-thumb:hover {
    transform: scale(1.3);
    box-shadow: 0 6px 20px rgba(14, 165, 233, 0.6);
}

.range-input::-webkit-slider-thumb:active {
    transform: scale(1.1);
}

.range-value {
    display: flex;
    justify-content: center;
    font-weight: 700;
    color: var(--accent-blue);
    margin-top: 8px;
    font-size: 1em;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    animation: bounceIn 0.6s ease-out;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 12px;
    font-weight: 600;
    transition: var(--transition-bounce);
    position: relative;
    overflow: hidden;
}

.status-indicator::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 1s;
}

.status-indicator.connected {
    background: rgba(5, 150, 105, 0.15);
    color: var(--accent-green);
    border: 2px solid rgba(5, 150, 105, 0.3);
}

.status-indicator.connected:hover::before {
    left: 100%;
}

.status-indicator.disconnected {
    background: rgba(220, 38, 38, 0.15);
    color: var(--accent-red);
    border: 2px solid rgba(220, 38, 38, 0.3);
}

.status-indicator i {
    font-size: 0.8em;
    animation: pulse 2s infinite;
}

/* ================ DASHBOARD APRIMORADO ================ */
.dashboard-container {
    padding: 32px;
    max-width: 1600px;
    margin: 0 auto;
    animation: fadeInUp 0.8s ease-out;
}

/* ================ CARDS E WIDGETS APRIMORADOS ================ */
.metric-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 28px;
    position: relative;
    overflow: hidden;
    transition: var(--transition-bounce);
    backdrop-filter: blur(30px);
    box-shadow: var(--shadow);
    cursor: pointer;
}

.metric-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
    opacity: 0;
    transition: var(--transition);
}

.metric-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-2xl);
    border-color: var(--border-color-hover);
    background: var(--bg-card-hover);
}

.metric-card:hover::after {
    opacity: 1;
    animation: shimmer 1.5s ease-in-out;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(100%) rotate(45deg); }
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
    opacity: 0.8;
}

.chart-widget {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 28px;
    backdrop-filter: blur(30px);
    transition: var(--transition);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.chart-widget::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(14,165,233,0.05), rgba(5,150,105,0.05));
    opacity: 0;
    transition: var(--transition);
}

.chart-widget:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--border-color-hover);
}

.chart-widget:hover::before {
    opacity: 1;
}

/* ================ ANIMAÇÕES ================ */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-20px);
    }
    50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes pulse {
    0%, 100% { 
        opacity: 1;
        transform: scale(1);
    }
    50% { 
        opacity: 0.7;
        transform: scale(1.05);
    }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Animação de entrada para os cards */
.metric-card {
    animation: fadeInUp 0.6s ease-out;
}

.metric-card:nth-child(1) { animation-delay: 0.1s; }
.metric-card:nth-child(2) { animation-delay: 0.2s; }
.metric-card:nth-child(3) { animation-delay: 0.3s; }
.metric-card:nth-child(4) { animation-delay: 0.4s; }

.chart-widget {
    animation: fadeInUp 0.8s ease-out 0.3s both;
}

/* ================ RESPONSIVO APRIMORADO ================ */
@media (max-width: 1024px) {
    .sidebar {
        transform: translateX(-100%);
        width: var(--sidebar-width);
    }
    
    .sidebar.show {
        transform: translateX(0);
    }
    
    .sidebar.collapsed {
        transform: translateX(-100%);
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .main-content.expanded {
        margin-left: 0;
    }
}

@media (max-width: 768px) {
    :root {
        --sidebar-width: 100vw;
    }
    
    .sidebar {
        width: 100vw;
        border-right: none;
    }
    
    .toggle-sidebar {
        z-index: 1001;
    }
}

/* ================ MELHORIAS GERAIS ================ */
.widget-action {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--white);
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition-bounce);
    font-size: 0.875em;
    position: relative;
    overflow: hidden;
}

.widget-action::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: radial-gradient(circle, var(--accent-blue) 0%, transparent 70%);
    transition: var(--transition);
    transform: translate(-50%, -50%);
    opacity: 0;
}

.widget-action:hover {
    background: var(--bg-card-hover);
    border-color: var(--accent-blue);
    transform: scale(1.1);
    box-shadow: var(--shadow);
}

.widget-action:hover::before {
    width: 40px;
    height: 40px;
    opacity: 0.2;
}

.widget-action:active {
    transform: scale(0.95);
}

/* ================ SCROLLBAR APRIMORADA ================ */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: var(--primary-dark);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(45deg, var(--accent-blue), var(--accent-green));
    border-radius: 3px;
    transition: var(--transition);
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(45deg, var(--accent-blue-dark), var(--accent-green-dark));
    transform: scale(1.2);
}

/* ================ ESTADOS DE CARREGAMENTO ================ */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(10px);
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.loading-spinner {
    text-align: center;
    color: var(--white);
    animation: bounceIn 0.6s ease-out;
}

.loading-spinner i {
    font-size: 3em;
    color: var(--accent-blue);
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
    filter: drop-shadow(0 4px 8px rgba(14, 165, 233, 0.3));
}

/* ================ MELHORIAS DE ACESSIBILIDADE ================ */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Focus aprimorado */
.nav-item:focus,
.toggle-sidebar:focus,
.refresh-btn:focus,
.control-group input:focus,
.control-group select:focus,
.widget-action:focus {
    outline: 3px solid var(--accent-blue);
    outline-offset: 2px;
    box-shadow: 0 0 0 6px rgba(14, 165, 233, 0.2);
}

/* ================ MICRO INTERAÇÕES ================ */
.metric-content h3 {
    transition: var(--transition);
}

.metric-card:hover .metric-content h3 {
    transform: scale(1.05);
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.nav-item:hover i {
    animation: bounceIn 0.6s ease-out;
}

.widget-title i {
    transition: var(--transition-bounce);
}

.chart-widget:hover .widget-title i {
    transform: scale(1.2) rotate(10deg);
    color: var(--accent-green);
}

/* ================ ALERTAS APRIMORADOS ================ */
.alert {
    padding: 16px 20px;
    border-radius: 16px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
    animation: slideInDown 0.4s ease-out;
    backdrop-filter: blur(20px);
    position: relative;
    overflow: hidden;
    border: 1px solid;
}

.alert::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: slideAcross 2s ease-in-out infinite;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideAcross {
    0%, 100% { left: -100%; }
    50% { left: 100%; }
}

.alert.success {
    background: rgba(5, 150, 105, 0.2);
    border-color: rgba(5, 150, 105, 0.4);
    color: var(--accent-green);
}

.alert.warning {
    background: rgba(217, 119, 6, 0.2);
    border-color: rgba(217, 119, 6, 0.4);
    color: var(--accent-orange);
}

.alert.danger {
    background: rgba(220, 38, 38, 0.2);
    border-color: rgba(220, 38, 38, 0.4);
    color: var(--accent-red);
}

.alert.info {
    background: rgba(14, 165, 233, 0.2);
    border-color: rgba(14, 165, 233, 0.4);
    color: var(--accent-blue);
}

/* ================ MODAL STYLES ================ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(15, 23, 42, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(10px);
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 32px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-2xl);
    transform: scale(0.7) translateY(-50px);
    transition: var(--transition-bounce);
}

.modal-overlay.show .modal-content {
    transform: scale(1) translateY(0);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    font-size: 1.5em;
    font-weight: 700;
    color: var(--white);
}

.modal-close {
    background: none;
    border: none;
    color: var(--gray-400);
    font-size: 1.5em;
    cursor: pointer;
    transition: var(--transition);
    border-radius: 6px;
    padding: 8px;
}

.modal-close:hover {
    color: var(--white);
    background: var(--bg-card-hover);
    transform: scale(1.1);
}

/* ================ PAGE CONTENT STYLES ================ */
.page-content {
    display: none;
    padding: 32px;
    max-width: 1200px;
    margin: 0 auto;
    animation: fadeInUp 0.6s ease-out;
}

.page-content.active {
    display: block;
}

.page-header-section {
    margin-bottom: 32px;
    text-align: center;
}

.page-header-section h1 {
    font-size: 2.5em;
    font-weight: 800;
    color: var(--white);
    margin-bottom: 12px;
    background: linear-gradient(135deg, var(--white), var(--accent-blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.page-header-section p {
    color: var(--gray-400);
    font-size: 1.1em;
    font-weight: 500;
}

.report-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow);
}

.report-section h2 {
    color: var(--accent-blue);
    font-size: 1.5em;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.report-section h3 {
    color: var(--white);
    font-size: 1.2em;
    font-weight: 600;
    margin: 24px 0 12px 0;
    border-left: 4px solid var(--accent-green);
    padding-left: 16px;
}

.report-table {
    width: 100%;
    margin: 20px 0;
    border-collapse: collapse;
    background: rgba(15, 23, 42, 0.3);
    border-radius: 12px;
    overflow: hidden;
}

.report-table th {
    background: rgba(15, 23, 42, 0.5);
    color: var(--gray-200);
    font-weight: 700;
    padding: 16px;
    text-align: left;
    border-bottom: 2px solid var(--border-color);
}

.report-table td {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--gray-300);
}

.report-table tr:hover {
    background: rgba(30, 41, 59, 0.3);
}

.highlight-box {
    background: rgba(14, 165, 233, 0.1);
    border: 1px solid rgba(14, 165, 233, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    color: var(--accent-blue);
}

.highlight-box.success {
    background: rgba(5, 150, 105, 0.1);
    border-color: rgba(5, 150, 105, 0.3);
    color: var(--accent-green);
}

.highlight-box.warning {
    background: rgba(217, 119, 6, 0.1);
    border-color: rgba(217, 119, 6, 0.3);
    color: var(--accent-orange);
}

.coming-soon {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-400);
}

.coming-soon i {
    font-size: 4em;
    margin-bottom: 20px;
    color: var(--accent-blue);
}

.coming-soon h2 {
    font-size: 2em;
    margin-bottom: 12px;
    color: var(--white);
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.metric-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.metric-content h3 {
    font-size: 2.4em;
    font-weight: 800;
    color: var(--white);
    margin: 8px 0;
    line-height: 1;
}

.metric-content p {
    color: var(--gray-300);
    font-size: 0.9em;
    font-weight: 500;
    margin-bottom: 12px;
}

.metric-trend {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85em;
    font-weight: 600;
}

.metric-trend.positive { 
    color: var(--accent-green); 
}
.metric-trend.negative { 
    color: var(--accent-red); 
}
.metric-trend.neutral { 
    color: var(--gray-400); 
}

.metric-icon {
    width: 52px;
    height: 52px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
    color: var(--white);
    box-shadow: var(--shadow);
}

.metric-icon.blue { 
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark)); 
}
.metric-icon.green { 
    background: linear-gradient(135deg, var(--accent-green), var(--accent-green-dark)); 
}
.metric-icon.orange { 
    background: linear-gradient(135deg, var(--accent-orange), #f59e0b); 
}
.metric-icon.red { 
    background: linear-gradient(135deg, var(--accent-red), #ef4444); 
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.chart-widget.full-width {
    grid-column: 1 / -1;
}

.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.widget-title {
    font-size: 1.25em;
    font-weight: 700;
    color: var(--white);
    display: flex;
    align-items: center;
    gap: 12px;
}

.widget-title i {
    color: var(--accent-blue);
}

.widget-actions {
    display: flex;
    gap: 8px;
}

.chart-container {
    position: relative;
    height: 320px;
}

.chart-container.small {
    height: 250px;
}

.chart-container.large {
    height: 400px;
}

.data-table {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    overflow: hidden;
    backdrop-filter: blur(20px);
    margin-bottom: 32px;
    box-shadow: var(--shadow-sm);
}

.table-header {
    padding: 24px 28px;
    background: rgba(15, 23, 42, 0.5);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-title {
    font-size: 1.25em;
    font-weight: 700;
    color: var(--white);
    display: flex;
    align-items: center;
    gap: 12px;
}

.table-content {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 16px 20px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

th {
    background: rgba(15, 23, 42, 0.3);
    color: var(--gray-200);
    font-weight: 700;
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

td {
    color: var(--gray-300);
    font-weight: 500;
}

tr:hover {
    background: rgba(30, 41, 59, 0.3);
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.status-badge.success {
    background: rgba(5, 150, 105, 0.2);
    color: var(--accent-green);
}

.status-badge.warning {
    background: rgba(217, 119, 6, 0.2);
    color: var(--accent-orange);
}

.status-badge.danger {
    background: rgba(220, 38, 38, 0.2);
    color: var(--accent-red);
}

/* ================ DEBUG PANEL ================ */
.debug-panel {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 11px;
    z-index: 10000;
    max-width: 250px;
    border: 1px solid #333;
}
.debug-item {
    margin: 3px 0;
    display: flex;
    justify-content: space-between;
}
.debug-status {
    margin-left: 5px;
}
.status-ok { color: #10b981; }
.status-error { color: #ef4444; }
.status-loading { color: #f59e0b; }
    </style>
    
    <!-- Debug Panel CSS -->
</head>
<body>
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div><strong>🔧 DEBUG</strong></div>
        <div class="debug-item">
            <span>Chart.js:</span>
            <span class="debug-status status-loading" id="debugChart">Loading...</span>
        </div>
        <div class="debug-item">
            <span>jsPDF:</span>
            <span class="debug-status status-loading" id="debugPDF">Loading...</span>
        </div>
        <div class="debug-item">
            <span>API:</span>
            <span class="debug-status status-loading" id="debugAPI">Testing...</span>
        </div>
        <div class="debug-item">
            <span>Gráficos:</span>
            <span class="debug-status status-loading" id="debugGraphs">Waiting...</span>
        </div>
        <button onclick="document.getElementById('debugPanel').style.display='none'" 
                style="margin-top: 8px; padding: 4px 8px; background: #333; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">
            Fechar
        </button>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner"></i>
            <h3>Carregando dados...</h3>
            <p>Aguarde enquanto processamos as informações</p>
        </div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="logo">
                <i class="fas fa-coins"></i>
                <span class="logo-text">CIMO</span>
            </a>
        </div>
        <div class="nav-menu">
            <div class="nav-section">
                <div class="nav-section-title">Principal</div>
                <a href="#" class="nav-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-item-text">Dashboard</span>
                    <span class="nav-item-tooltip">Dashboard Principal</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('allocation')">
                    <i class="fas fa-chart-pie"></i>
                    <span class="nav-item-text">Asset Allocation</span>
                    <span class="nav-item-tooltip">Alocação de Ativos</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('projections')">
                    <i class="fas fa-trending-up"></i>
                    <span class="nav-item-text">Projeções</span>
                    <span class="nav-item-tooltip">Projeções Financeiras</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Análises</div>
                <a href="#" class="nav-item" onclick="showPage('simulations')">
                    <i class="fas fa-calculator"></i>
                    <span class="nav-item-text">Simulações</span>
                    <span class="badge">3</span>
                    <span class="nav-item-tooltip">Simulações de Cenários</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('scenarios')">
                    <i class="fas fa-balance-scale"></i>
                    <span class="nav-item-text">Cenários</span>
                    <span class="nav-item-tooltip">Análise de Cenários</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('sensitivity')">
                    <i class="fas fa-chart-area"></i>
                    <span class="nav-item-text">Sensibilidade</span>
                    <span class="nav-item-tooltip">Análise de Sensibilidade</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Relatórios</div>
                <a href="#" class="nav-item" onclick="showPage('executive')">
                    <i class="fas fa-file-alt"></i>
                    <span class="nav-item-text">Executivo</span>
                    <span class="nav-item-tooltip">Relatório Executivo</span>
                </a>
                <a href="#" class="nav-item" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i>
                    <span class="nav-item-text">Exportar PDF</span>
                    <span class="nav-item-tooltip">Gerar PDF</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i>
                    <span class="nav-item-text">Configurações</span>
                    <span class="nav-item-tooltip">Configurações do Sistema</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Dashboard Page -->
        <div class="page-content active" id="dashboardPage">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="toggle-sidebar" id="toggleSidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="page-header">
                        <h1>Plano Patrimonial Ana</h1>
                        <p>Análise estratégica de investimentos e alocação de recursos financeiros</p>
                    </div>
                </div>
                <div class="top-bar-right">
                    <button class="refresh-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        <span>Atualizar</span>
                    </button>
                </div>
            </header>

            <!-- Controls Bar -->
            <section class="controls-bar">
                <div class="controls-grid">
                    <div class="control-group">
                        <label for="taxaRetorno">Taxa de Retorno (%)</label>
                        <div class="range-container">
                            <input type="range" id="taxaRetorno" class="range-input" min="2" max="8" step="0.1" value="4.0">
                            <div class="range-value" id="taxaDisplay">4.0%</div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="expectativaVida">Expectativa de Vida</label>
                        <select id="expectativaVida">
                            <option value="85">85 anos</option>
                            <option value="90" selected>90 anos</option>
                            <option value="95">95 anos</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label for="despesasMensais">Despesas Mensais (R$)</label>
                        <input type="number" id="despesasMensais" value="150000" step="5000" min="50000" max="500000">
                    </div>
                    
                    <div class="control-group">
                        <label>Status Sistema</label>
                        <div class="status-indicator connected" id="statusSistema">
                            <i class="fas fa-circle"></i>
                            <span>Conectado</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Dashboard Content -->
            <div class="dashboard-container">
                <!-- Alert Container -->
                <div class="alert-container" id="alertContainer"></div>

                <!-- Main Metrics -->
                <section class="metrics-grid">
                    <article class="metric-card success" id="cardPatrimonio">
                        <div class="metric-header">
                            <div class="metric-content">
                                <h3 id="valorPatrimonio">R$ 65,0M</h3>
                                <p>Patrimônio Total</p>
                                <div class="metric-trend neutral">
                                    <i class="fas fa-wallet"></i>
                                    <span>Base de cálculo</span>
                                </div>
                            </div>
                            <div class="metric-icon blue">
                                <i class="fas fa-coins"></i>
                            </div>
                        </div>
                    </article>

                    <article class="metric-card" id="cardFazenda">
                        <div class="metric-header">
                            <div class="metric-content">
                                <h3 id="valorFazenda">R$ 5,2M</h3>
                                <p>Disponível para Fazenda</p>
                                <div class="metric-trend" id="trendFazenda">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="percentualFazenda">8.0%</span>
                                </div>
                            </div>
                            <div class="metric-icon green">
                                <i class="fas fa-seedling"></i>
                            </div>
                        </div>
                    </article>

                    <article class="metric-card warning" id="cardCompromissos">
                        <div class="metric-header">
                            <div class="metric-content">
                                <h3 id="valorCompromissos">R$ 59,8M</h3>
                                <p>Total Compromissos</p>
                                <div class="metric-trend neutral">
                                    <i class="fas fa-handshake"></i>
                                    <span>Valor presente</span>
                                </div>
                            </div>
                            <div class="metric-icon orange">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                        </div>
                    </article>

                    <article class="metric-card info" id="cardStatus">
                        <div class="metric-header">
                            <div class="metric-content">
                                <h3 id="valorStatus">Viável</h3>
                                <p>Status do Plano</p>
                                <div class="metric-trend positive">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Objetivos atingíveis</span>
                                </div>
                            </div>
                            <div class="metric-icon blue">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                    </article>
                </section>

                <!-- Charts Grid -->
                <section class="charts-grid">
                    <!-- Breakdown dos Compromissos -->
                    <article class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">
                                <i class="fas fa-chart-pie"></i>
                                Breakdown dos Compromissos
                            </h3>
                            <div class="widget-actions">
                                <button class="widget-action" onclick="exportChart('compromissos')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="compromissosChart"></canvas>
                            <div id="compromissosError" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444; text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i><br>
                                Erro ao carregar gráfico
                            </div>
                        </div>
                    </article>

                    <!-- Asset Allocation -->
                    <article class="chart-widget">
                        <div class="widget-header">
                            <h3 class="widget-title">
                                <i class="fas fa-chart-donut"></i>
                                Asset Allocation
                            </h3>
                            <div class="widget-actions">
                                <button class="widget-action" onclick="exportChart('allocation')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="allocationChart"></canvas>
                            <div id="allocationError" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444; text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i><br>
                                Erro ao carregar gráfico
                            </div>
                        </div>
                    </article>

                    <!-- Análise de Sensibilidade -->
                    <article class="chart-widget full-width">
                        <div class="widget-header">
                            <h3 class="widget-title">
                                <i class="fas fa-chart-line"></i>
                                Análise de Sensibilidade - Impacto da Taxa de Retorno
                            </h3>
                            <div class="widget-actions">
                                <button class="widget-action" onclick="exportChart('sensibilidade')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="widget-action" onclick="toggleFullscreen('sensibilidadeChart')">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container large">
                            <canvas id="sensibilidadeChart"></canvas>
                            <div id="sensibilidadeError" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ef4444; text-align: center;">
                                <i class="fas fa-exclamation-triangle"></i><br>
                                Erro ao carregar gráfico
                            </div>
                        </div>
                    </article>
                </section>

                <!-- Tabela de Cenários -->
                <section class="data-table">
                    <div class="table-header">
                        <h3 class="table-title">
                            <i class="fas fa-table"></i>
                            Análise Comparativa de Cenários
                        </h3>
                        <div class="widget-actions">
                            <button class="widget-action" onclick="exportTable()">
                                <i class="fas fa-file-excel"></i>
                                Exportar CSV
                            </button>
                        </div>
                    </div>
                    <div class="table-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Taxa Real (%)</th>
                                    <th>Valor Fazenda</th>
                                    <th>% Patrimônio</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="cenarioTableBody">
                                <!-- Dados carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>

        <!-- Executive Report Page -->
        <div class="page-content" id="executivePage">
            <div class="page-header-section">
                <h1><i class="fas fa-file-alt"></i> Relatório Executivo</h1>
                <p>Plano Patrimonial para Ana - Case Study Cimo Family Office</p>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-bullseye"></i> Resumo Executivo</h2>
                <div class="highlight-box success">
                    <h3>Pergunta Central</h3>
                    <p><strong>"Quanto posso gastar com a fazenda e ainda garantir o cumprimento dos meus objetivos de vida e legado?"</strong></p>
                </div>
                <div class="highlight-box">
                    <h3>Resposta</h3>
                    <p>Com uma estratégia de investimentos que gere 4-5% de retorno real anual, Ana pode investir entre <strong>R$5,2 milhões e R$13,4 milhões</strong> na fazenda, mantendo todos os seus objetivos de vida e legado.</p>
                </div>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-user-circle"></i> 1. Diagnóstico Inicial</h2>
                <h3>Perfil do Cliente</h3>
                <ul style="color: var(--gray-300); margin-left: 20px;">
                    <li>Ana, 53 anos, empresária bem-sucedida</li>
                    <li>Patrimônio líquido: R$65 milhões (pós-impostos)</li>
                    <li>Perfil: Conservador, busca segurança e perenidade</li>
                    <li>Três filhos adultos e formados</li>
                </ul>

                <h3>Compromissos Financeiros Explícitos</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Compromisso</th>
                            <th>Valor Mensal</th>
                            <th>Período</th>
                            <th>Valor Presente (4% real)</th>
                            <th>% do Patrimônio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Despesas Pessoais de Ana</strong></td>
                            <td>R$ 150.000</td>
                            <td>37 anos (até 90 anos)</td>
                            <td>R$ 32.200.000</td>
                            <td>49,5%</td>
                        </tr>
                        <tr>
                            <td><strong>Legado para os Filhos</strong></td>
                            <td>R$ 150.000 (R$ 50k/filho)</td>
                            <td>25 anos (dos 65 aos 90 anos)</td>
                            <td>R$ 18.900.000</td>
                            <td>29,1%</td>
                        </tr>
                        <tr>
                            <td><strong>Doações Filantrópicas</strong></td>
                            <td>R$ 50.000</td>
                            <td>15 anos</td>
                            <td>R$ 8.700.000</td>
                            <td>13,4%</td>
                        </tr>
                        <tr style="background: rgba(14, 165, 233, 0.1);">
                            <td><strong>Total de Compromissos</strong></td>
                            <td>-</td>
                            <td>-</td>
                            <td><strong>R$ 59.800.000</strong></td>
                            <td><strong>92,0%</strong></td>
                        </tr>
                        <tr style="background: rgba(5, 150, 105, 0.1);">
                            <td><strong>Disponível para Fazenda</strong></td>
                            <td>-</td>
                            <td>-</td>
                            <td><strong>R$ 5.200.000</strong></td>
                            <td><strong>8,0%</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-chart-line"></i> 2. Análise de Cenários</h2>
                <h3>Análise de Sensibilidade</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Taxa Real</th>
                            <th>Total Compromissos</th>
                            <th>Valor Fazenda</th>
                            <th>% Patrimônio</th>
                            <th>Viabilidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: rgba(220, 38, 38, 0.1);">
                            <td>3,0%</td>
                            <td>R$ 70.000.000</td>
                            <td>-R$ 5.000.000</td>
                            <td>-7,7%</td>
                            <td><span class="status-badge danger">Inviável</span></td>
                        </tr>
                        <tr style="background: rgba(217, 119, 6, 0.1);">
                            <td>3,5%</td>
                            <td>R$ 64.600.000</td>
                            <td>R$ 400.000</td>
                            <td>0,6%</td>
                            <td><span class="status-badge warning">Crítico</span></td>
                        </tr>
                        <tr style="background: rgba(5, 150, 105, 0.1);">
                            <td><strong>4,0%</strong></td>
                            <td>R$ 59.800.000</td>
                            <td><strong>R$ 5.200.000</strong></td>
                            <td><strong>8,0%</strong></td>
                            <td><span class="status-badge success">Viável</span></td>
                        </tr>
                        <tr style="background: rgba(5, 150, 105, 0.1);">
                            <td>5,0%</td>
                            <td>R$ 51.600.000</td>
                            <td>R$ 13.400.000</td>
                            <td>20,6%</td>
                            <td><span class="status-badge success">Excelente</span></td>
                        </tr>
                        <tr style="background: rgba(5, 150, 105, 0.1);">
                            <td>6,0%</td>
                            <td>R$ 45.000.000</td>
                            <td>R$ 20.000.000</td>
                            <td>30,8%</td>
                            <td><span class="status-badge success">Excelente</span></td>
                        </tr>
                    </tbody>
                </table>
                <div class="highlight-box warning">
                    <p><strong>Taxa Mínima Necessária:</strong> 3,5% real a.a.</p>
                </div>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-chart-pie"></i> 3. Proposta de Alocação de Recursos</h2>
                <h3>Asset Allocation Sugerida</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Classe de Ativo</th>
                            <th>Alocação</th>
                            <th>Valor (R$ milhões)</th>
                            <th>Retorno Esperado</th>
                            <th>Objetivo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Renda Fixa Nacional</td>
                            <td>40%</td>
                            <td>24,0</td>
                            <td>3,5% real</td>
                            <td>Base conservadora</td>
                        </tr>
                        <tr>
                            <td>Renda Fixa Internacional</td>
                            <td>15%</td>
                            <td>9,0</td>
                            <td>2,5% real</td>
                            <td>Diversificação moeda</td>
                        </tr>
                        <tr>
                            <td>Multimercado</td>
                            <td>15%</td>
                            <td>9,0</td>
                            <td>4,5% real</td>
                            <td>Proteção + retorno</td>
                        </tr>
                        <tr>
                            <td>Ações Brasil</td>
                            <td>10%</td>
                            <td>6,0</td>
                            <td>6,0% real</td>
                            <td>Crescimento doméstico</td>
                        </tr>
                        <tr>
                            <td>Ações Internacionais</td>
                            <td>10%</td>
                            <td>6,0</td>
                            <td>5,5% real</td>
                            <td>Crescimento global</td>
                        </tr>
                        <tr>
                            <td>Imóveis/REITs</td>
                            <td>5%</td>
                            <td>3,0</td>
                            <td>4,0% real</td>
                            <td>Hedge inflação</td>
                        </tr>
                        <tr>
                            <td>Reserva de Liquidez</td>
                            <td>5%</td>
                            <td>3,0</td>
                            <td>1,5% real</td>
                            <td>Emergências</td>
                        </tr>
                        <tr style="background: rgba(14, 165, 233, 0.1);">
                            <td><strong>TOTAL</strong></td>
                            <td><strong>100%</strong></td>
                            <td><strong>60,0</strong></td>
                            <td><strong>4,2% real</strong></td>
                            <td><strong>Portfólio balanceado</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-tractor"></i> 4. Investimento na Fazenda</h2>
                <h3>Estruturação Recomendada</h3>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Valor</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Aquisição</td>
                            <td>R$ 3.500.000</td>
                            <td>Terra e infraestrutura básica</td>
                        </tr>
                        <tr>
                            <td>Benfeitorias iniciais</td>
                            <td>R$ 1.000.000</td>
                            <td>Instalações para criação</td>
                        </tr>
                        <tr>
                            <td>Capital de giro</td>
                            <td>R$ 700.000</td>
                            <td>Operação e manutenção</td>
                        </tr>
                        <tr style="background: rgba(5, 150, 105, 0.1);">
                            <td><strong>Total Disponível</strong></td>
                            <td><strong>R$ 5.200.000</strong></td>
                            <td><strong>Cenário base (4% real)</strong></td>
                        </tr>
                    </tbody>
                </table>

                <h3>Benefícios Esperados</h3>
                <ul style="color: var(--gray-300); margin-left: 20px;">
                    <li>Diversificação de portfólio</li>
                    <li>Hedge contra inflação</li>
                    <li>Realização pessoal e qualidade de vida</li>
                    <li>Potencial geração de renda (agronegócio)</li>
                    <li>Legado familiar tangível</li>
                </ul>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-shield-alt"></i> 5. Gestão de Riscos</h2>
                <h3>Principais Riscos e Mitigações</h3>
                
                <h3>Risco de Longevidade</h3>
                <p style="color: var(--gray-300);">
                    <strong>Mitigação:</strong> Seguro de vida, planejamento até 95 anos<br>
                    <strong>Monitoramento:</strong> Revisão quinquenal das premissas
                </p>

                <h3>Risco de Mercado</h3>
                <p style="color: var(--gray-300);">
                    <strong>Mitigação:</strong> Diversificação ampla, rebalanceamento<br>
                    <strong>Stress test:</strong> Cenários de crise e baixo retorno
                </p>

                <h3>Risco Inflacionário</h3>
                <p style="color: var(--gray-300);">
                    <strong>Mitigação:</strong> Ativos indexados à inflação, ativos reais<br>
                    <strong>Hedge:</strong> Fazenda como proteção natural
                </p>

                <h3>Planos de Contingência</h3>
                <div class="highlight-box warning">
                    <h4>Se retornos &lt; 3,5%</h4>
                    <ol style="color: var(--gray-300); margin-left: 20px;">
                        <li>Redução gradual das doações (de R$50k para R$30k/mês)</li>
                        <li>Postergação do início da renda dos filhos (65→70 anos)</li>
                        <li>Redução do valor da fazenda</li>
                        <li>Revisão do padrão de vida (R$150k→R$120k/mês)</li>
                    </ol>
                </div>
            </div>

            <div class="report-section">
                <h2><i class="fas fa-check-circle"></i> 6. Conclusões</h2>
                <div class="highlight-box success">
                    <h3>Viabilidade do Plano</h3>
                    <p>✅ <strong>VIÁVEL</strong> com retorno real de 4-5% a.a.<br>
                    ✅ <strong>Fazenda:</strong> R$5,2 milhões disponíveis<br>
                    ✅ <strong>Todos os objetivos preservados</strong><br>
                    ⚠️ <strong>Arte/Galeria:</strong> Reavaliação em 3-5 anos</p>
                </div>

                <h3>Fatores Críticos de Sucesso</h3>
                <ol style="color: var(--gray-300); margin-left: 20px;">
                    <li>Disciplina na execução da estratégia</li>
                    <li>Diversificação adequada dos riscos</li>
                    <li>Monitoramento ativo da performance</li>
                    <li>Flexibilidade para ajustes necessários</li>
                </ol>

                <h3>Próximos Passos</h3>
                <ol style="color: var(--gray-300); margin-left: 20px;">
                    <li>Aprovação do plano pela Ana</li>
                    <li>Estruturação legal (holding, previdência)</li>
                    <li>Implementação gradual do portfólio</li>
                    <li>Início da busca pela fazenda ideal</li>
                </ol>

                <div class="highlight-box">
                    <p style="font-style: italic; text-align: center; margin: 0;">
                        "O planejamento patrimonial bem-sucedido não é sobre prever o futuro, mas sobre criar flexibilidade para adaptação aos diferentes cenários possíveis."
                    </p>
                    <p style="text-align: center; margin-top: 10px; font-weight: bold;">
                        Cimo Family Office - 2025
                    </p>
                </div>
            </div>
        </div>

        <!-- Other Pages (Placeholder) -->
        <div class="page-content" id="allocationPage">
            <div class="coming-soon">
                <i class="fas fa-chart-pie"></i>
                <h2>Asset Allocation</h2>
                <p>Análise detalhada da alocação de ativos em desenvolvimento.</p>
            </div>
        </div>

        <div class="page-content" id="projectionsPage">
            <div class="coming-soon">
                <i class="fas fa-trending-up"></i>
                <h2>Projeções Financeiras</h2>
                <p>Projeções de fluxo de caixa e crescimento patrimonial em desenvolvimento.</p>
            </div>
        </div>

        <div class="page-content" id="simulationsPage">
            <div class="coming-soon">
                <i class="fas fa-calculator"></i>
                <h2>Simulações</h2>
                <p>Simulador interativo de cenários em desenvolvimento.</p>
            </div>
        </div>

        <div class="page-content" id="scenariosPage">
            <div class="coming-soon">
                <i class="fas fa-balance-scale"></i>
                <h2>Análise de Cenários</h2>
                <p>Comparação detalhada de cenários em desenvolvimento.</p>
            </div>
        </div>

        <div class="page-content" id="sensitivityPage">
            <div class="coming-soon">
                <i class="fas fa-chart-area"></i>
                <h2>Análise de Sensibilidade</h2>
                <p>Análise avançada de sensibilidade em desenvolvimento.</p>
            </div>
        </div>

        <div class="page-content" id="settingsPage">
            <div class="coming-soon">
                <i class="fas fa-cog"></i>
                <h2>Configurações</h2>
                <p>Configurações do sistema em desenvolvimento.</p>
            </div>
        </div>
    </main>

    <script>
        // ================ DEBUG SYSTEM ================
        const Debug = {
            updateStatus(id, status, message) {
                const el = document.getElementById(id);
                if (el) {
                    el.className = `debug-status status-${status}`;
                    el.textContent = message || status;
                }
            },

            log(message, data = null) {
                console.log(`[DEBUG] ${message}`, data || '');
            }
        };

        // ================ LIBRARY CHECKS ================
        function checkLibraries() {
            // Check Chart.js
            if (typeof Chart !== 'undefined') {
                Debug.updateStatus('debugChart', 'ok', `v${Chart.version}`);
                Debug.log('Chart.js loaded successfully', Chart.version);
            } else {
                Debug.updateStatus('debugChart', 'error', 'Failed');
                Debug.log('Chart.js failed to load');
            }

            // Check jsPDF
            if (typeof window.jsPDF !== 'undefined') {
                Debug.updateStatus('debugPDF', 'ok', 'Ready');
                Debug.log('jsPDF loaded successfully');
            } else {
                Debug.updateStatus('debugPDF', 'error', 'Failed');
                Debug.log('jsPDF failed to load - will use HTML fallback for PDF export');
            }
        }

        // ================ CONFIG ================
        const CONFIG = {
            API_BASE: '/api',
            CHART_COLORS: ['#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed', '#0891b2', '#be185d']
        };

        const AppState = {
            currentData: null,
            charts: {},
            isLoading: false,
            currentPage: 'dashboard'
        };

        // ================ PAGE NAVIGATION ================
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                AppState.currentPage = pageId;
            }
            
            // Add active class to clicked nav item
            event.target.closest('.nav-item').classList.add('active');
            
            // Update page title based on selected page
            const titles = {
                'dashboard': 'Plano Patrimonial Ana',
                'allocation': 'Asset Allocation',
                'projections': 'Projeções Financeiras',
                'simulations': 'Simulações',
                'scenarios': 'Análise de Cenários',
                'sensitivity': 'Análise de Sensibilidade',
                'executive': 'Relatório Executivo',
                'settings': 'Configurações'
            };
            
            if (pageId !== 'dashboard') {
                document.querySelector('.page-header h1').textContent = titles[pageId] || 'CIMO Dashboard';
            }
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth <= 1024) {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                sidebar.classList.remove('show');
                mainContent.classList.remove('sidebar-open');
            }
        }

        // ================ UTILITIES ================
        const Utils = {
            formatCurrency(value, compact = false) {
                if (value === null || value === undefined) return 'N/A';
                
                if (compact && Math.abs(value) >= 1000000) {
                    return `R$ ${(value / 1000000).toFixed(1)}M`;
                }
                
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            },

            formatPercentage(value, decimals = 1) {
                if (value === null || value === undefined) return 'N/A';
                return `${value.toFixed(decimals)}%`;
            },

            showNotification(message, type = 'info', duration = 5000) {
                const container = document.getElementById('alertContainer');
                const alertId = 'alert-' + Date.now();
                
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'times-circle',
                    info: 'info-circle'
                };
                
                const alertHTML = `
                    <div id="${alertId}" class="alert ${type}">
                        <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', alertHTML);
                
                if (duration > 0) {
                    setTimeout(() => {
                        const alert = document.getElementById(alertId);
                        if (alert) {
                            alert.style.opacity = '0';
                            alert.style.transform = 'translateY(-20px)';
                            setTimeout(() => alert.remove(), 300);
                        }
                    }, duration);
                }
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // ================ API CLIENT ================
        const ApiClient = {
            async getDashboardData() {
                try {
                    const params = {
                        taxa: document.getElementById('taxaRetorno').value,
                        expectativa: document.getElementById('expectativaVida').value,
                        despesas: document.getElementById('despesasMensais').value
                    };

                    const url = new URL(`${window.location.origin}${CONFIG.API_BASE}/dados`);
                    Object.keys(params).forEach(key => {
                        url.searchParams.append(key, params[key]);
                    });

                    Debug.log('Fetching data from:', url.toString());

                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.erro) {
                        throw new Error(data.erro);
                    }

                    Debug.updateStatus('debugAPI', 'ok', 'Connected');
                    Debug.log('Data received:', data);
                    return data;
                } catch (error) {
                    Debug.updateStatus('debugAPI', 'error', 'Failed');
                    Debug.log('API Error:', error);
                    throw error;
                }
            }
        };

        // ================ CHART MANAGER ================
        const ChartManager = {
            createCharts() {
                if (!AppState.currentData) {
                    Debug.log('No data available for charts');
                    return;
                }

                if (typeof Chart === 'undefined') {
                    Debug.log('Chart.js not available');
                    this.showAllErrors();
                    Debug.updateStatus('debugGraphs', 'error', 'Chart.js missing');
                    return;
                }

                try {
                    Debug.log('Creating charts...');
                    
                    this.hideAllErrors();
                    
                    this.createCompromissosChart();
                    this.createAllocationChart();
                    this.createSensibilidadeChart();
                    
                    Debug.updateStatus('debugGraphs', 'ok', 'Created');
                    Debug.log('All charts created successfully');
                } catch (error) {
                    Debug.log('Error creating charts:', error);
                    Debug.updateStatus('debugGraphs', 'error', 'Failed');
                    this.showAllErrors();
                }
            },

            hideAllErrors() {
                ['compromissosError', 'allocationError', 'sensibilidadeError'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            },

            showAllErrors() {
                ['compromissosError', 'allocationError', 'sensibilidadeError'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'block';
                });
            },

            createCompromissosChart() {
                const canvas = document.getElementById('compromissosChart');
                const ctx = canvas.getContext('2d');
                const { resultado } = AppState.currentData;
                
                if (AppState.charts.compromissos) {
                    AppState.charts.compromissos.destroy();
                }

                AppState.charts.compromissos = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Despesas Ana', 'Renda Filhos', 'Doações', 'Disponível Fazenda'],
                        datasets: [{
                            data: [
                                resultado.despesas,
                                resultado.filhos,
                                resultado.doacoes,
                                Math.max(resultado.fazenda, 0)
                            ],
                            backgroundColor: CONFIG.CHART_COLORS.slice(0, 4),
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        }
                    }
                });

                Debug.log('Compromissos chart created');
            },

            createAllocationChart() {
                const canvas = document.getElementById('allocationChart');
                const ctx = canvas.getContext('2d');
                const { allocation } = AppState.currentData;
                
                if (AppState.charts.allocation) {
                    AppState.charts.allocation.destroy();
                }

                AppState.charts.allocation = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: allocation.map(item => item.nome),
                        datasets: [{
                            data: allocation.map(item => item.percentual),
                            backgroundColor: CONFIG.CHART_COLORS.slice(0, allocation.length),
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#ffffff' }
                            }
                        }
                    }
                });

                Debug.log('Allocation chart created');
            },

            createSensibilidadeChart() {
                const canvas = document.getElementById('sensibilidadeChart');
                const ctx = canvas.getContext('2d');
                const { sensibilidade } = AppState.currentData;
                
                if (AppState.charts.sensibilidade) {
                    AppState.charts.sensibilidade.destroy();
                }

                AppState.charts.sensibilidade = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sensibilidade.map(item => `${item.taxa}%`),
                        datasets: [{
                            label: 'Valor Fazenda (R$ milhões)',
                            data: sensibilidade.map(item => item.fazenda / 1000000),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#ffffff' }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#ffffff' }
                            }
                        }
                    }
                });

                Debug.log('Sensibilidade chart created');
            }
        };

        // ================ UI MANAGER ================
        const UIManager = {
            updateMetrics() {
                if (!AppState.currentData) return;

                const { patrimonio, resultado, status } = AppState.currentData;
                
                document.getElementById('valorPatrimonio').textContent = Utils.formatCurrency(patrimonio, true);
                document.getElementById('valorFazenda').textContent = Utils.formatCurrency(resultado.fazenda, true);
                document.getElementById('percentualFazenda').textContent = Utils.formatPercentage(resultado.percentual);
                document.getElementById('valorCompromissos').textContent = Utils.formatCurrency(resultado.total, true);
                document.getElementById('valorStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);

                const trendEl = document.getElementById('trendFazenda');
                const icon = trendEl.querySelector('i');
                if (resultado.percentual >= 0) {
                    trendEl.className = 'metric-trend positive';
                    icon.className = 'fas fa-arrow-up';
                } else {
                    trendEl.className = 'metric-trend negative';
                    icon.className = 'fas fa-arrow-down';
                }
            },

            updateTable() {
                const { sensibilidade } = AppState.currentData;
                const tbody = document.getElementById('cenarioTableBody');
                
                tbody.innerHTML = sensibilidade.map(item => {
                    let statusClass, statusText;
                    
                    if (item.fazenda < 0) {
                        statusClass = 'danger';
                        statusText = 'Inviável';
                    } else if (item.fazenda >= 10000000) {
                        statusClass = 'success';
                        statusText = 'Excelente';
                    } else {
                        statusClass = 'warning';
                        statusText = 'Viável';
                    }

                    return `
                        <tr>
                            <td><strong>${item.taxa}%</strong></td>
                            <td><strong>${Utils.formatCurrency(item.fazenda, true)}</strong></td>
                            <td>${Utils.formatPercentage(item.percentual)}</td>
                            <td>
                                <span class="status-badge ${statusClass}">
                                    <i class="fas fa-circle"></i>
                                    ${statusText}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            updateAlerts() {
                const { status, resultado } = AppState.currentData;
                const container = document.getElementById('alertContainer');
                
                container.innerHTML = '';

                let alertType, alertMessage;

                if (status === 'crítico') {
                    alertType = 'danger';
                    alertMessage = `<strong>ATENÇÃO CRÍTICA:</strong> O patrimônio atual é insuficiente.`;
                } else if (status === 'atenção') {
                    alertType = 'warning';
                    alertMessage = `<strong>ATENÇÃO:</strong> Margem de segurança baixa.`;
                } else {
                    alertType = 'success';
                    alertMessage = `<strong>PLANO VIÁVEL:</strong> Fazenda: ${Utils.formatCurrency(resultado.fazenda, true)}.`;
                }

                container.innerHTML = `
                    <div class="alert ${alertType}">
                        <i class="fas fa-info-circle"></i>
                        ${alertMessage}
                    </div>
                `;
            }
        };

        // ================ SIDEBAR CONTROL ================
        const SidebarController = {
            init() {
                const toggleBtn = document.getElementById('toggleSidebar');
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                toggleBtn.addEventListener('click', () => {
                    if (window.innerWidth > 1024) {
                        // Desktop: toggle collapse
                        sidebar.classList.toggle('collapsed');
                        mainContent.classList.toggle('expanded');
                    } else {
                        // Mobile: toggle show/hide
                        sidebar.classList.toggle('show');
                        mainContent.classList.toggle('sidebar-open');
                    }
                });

                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 1024) {
                        if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                            sidebar.classList.remove('show');
                            mainContent.classList.remove('sidebar-open');
                        }
                    }
                });

                // Handle window resize
                window.addEventListener('resize', () => {
                    if (window.innerWidth > 1024) {
                        sidebar.classList.remove('show');
                        mainContent.classList.remove('sidebar-open');
                    } else {
                        sidebar.classList.remove('collapsed');
                        mainContent.classList.remove('expanded');
                    }
                });
            }
        };

        // ================ EXPORT FUNCTIONS ================
        function exportChart(chartId) {
            const chart = AppState.charts[chartId];
            if (chart) {
                const url = chart.toBase64Image();
                const link = document.createElement('a');
                link.download = `${chartId}-${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                link.click();
                
                Utils.showNotification('Gráfico exportado!', 'success');
            } else {
                Utils.showNotification('Gráfico não disponível', 'warning');
            }
        }

        function exportTable() {
            if (!AppState.currentData) {
                Utils.showNotification('Dados não carregados', 'warning');
                return;
            }

            const { sensibilidade } = AppState.currentData;
            let csv = 'Taxa (%),Valor Fazenda,% Patrimônio,Status\n';
            
            sensibilidade.forEach(item => {
                const status = item.fazenda < 0 ? 'Inviável' : item.fazenda >= 10000000 ? 'Excelente' : 'Viável';
                csv += `${item.taxa},${item.fazenda},${item.percentual.toFixed(2)},${status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analise-cenarios-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            Utils.showNotification('CSV exportado!', 'success');
        }

        function exportToPDF() {
            if (!AppState.currentData) {
                Utils.showNotification('Dados não carregados', 'warning');
                return;
            }

            // Verificar se jsPDF está disponível
            if (typeof window.jsPDF !== 'undefined') {
                generateJsPDF();
            } else {
                // Fallback: gerar HTML para impressão
                generateHTMLReport();
            }
        }

        function generateJsPDF() {
            try {
                const { jsPDF } = window;
                const doc = new jsPDF();
                
                // Título
                doc.setFontSize(20);
                doc.text('Plano Patrimonial Ana', 20, 30);
                
                doc.setFontSize(14);
                doc.text('CIMO Multi Family Office', 20, 45);
                
                // Data
                doc.setFontSize(12);
                doc.text(`Relatório gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 60);
                
                // Resumo
                const { patrimonio, resultado, status } = AppState.currentData;
                
                doc.setFontSize(16);
                doc.text('Resumo Executivo', 20, 80);
                
                doc.setFontSize(12);
                doc.text(`Patrimônio Total: ${Utils.formatCurrency(patrimonio)}`, 20, 95);
                doc.text(`Disponível para Fazenda: ${Utils.formatCurrency(resultado.fazenda)}`, 20, 110);
                doc.text(`Percentual: ${Utils.formatPercentage(resultado.percentual)}`, 20, 125);
                doc.text(`Status do Plano: ${status.toUpperCase()}`, 20, 140);
                
                // Breakdown
                doc.setFontSize(16);
                doc.text('Breakdown dos Compromissos', 20, 165);
                
                doc.setFontSize(12);
                doc.text(`Despesas Ana: ${Utils.formatCurrency(resultado.despesas)}`, 20, 180);
                doc.text(`Renda Filhos: ${Utils.formatCurrency(resultado.filhos)}`, 20, 195);
                doc.text(`Doações: ${Utils.formatCurrency(resultado.doacoes)}`, 20, 210);
                
                // Análise de Sensibilidade
                doc.setFontSize(16);
                doc.text('Análise de Sensibilidade', 20, 235);
                
                doc.setFontSize(10);
                doc.text('Taxa  |  Valor Fazenda  |  % Patrimônio  |  Status', 20, 250);
                
                let y = 260;
                AppState.currentData.sensibilidade.slice(0, 6).forEach(item => {
                    const status = item.fazenda < 0 ? 'Inviável' : item.fazenda >= 10000000 ? 'Excelente' : 'Viável';
                    doc.text(`${item.taxa}%      ${Utils.formatCurrency(item.fazenda, true)}      ${item.percentual.toFixed(1)}%      ${status}`, 20, y);
                    y += 12;
                });
                
                // Salvar
                doc.save(`plano-patrimonial-ana-${new Date().toISOString().split('T')[0]}.pdf`);
                
                Utils.showNotification('PDF exportado com jsPDF!', 'success');
            } catch (error) {
                console.error('Erro jsPDF:', error);
                Utils.showNotification('Erro no jsPDF, tentando método alternativo...', 'warning');
                generateHTMLReport();
            }
        }

        function generateHTMLReport() {
            try {
                const { patrimonio, resultado, status, sensibilidade } = AppState.currentData;
                
                const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Plano Patrimonial Ana - Relatório</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .section { margin-bottom: 30px; }
                        .metric { background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background: #f0f0f0; font-weight: bold; }
                        .status-viavel { color: #059669; font-weight: bold; }
                        .status-atencao { color: #d97706; font-weight: bold; }
                        .status-critico { color: #dc2626; font-weight: bold; }
                        @media print { body { margin: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Plano Patrimonial Ana</h1>
                        <h2>Cimo Family Office</h2>
                        <p>Relatório gerado em: ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}</p>
                    </div>
                    
                    <div class="section">
                        <h2>📊 Resumo Executivo</h2>
                        <div class="metric">
                            <strong>Patrimônio Total:</strong> ${Utils.formatCurrency(patrimonio)}
                        </div>
                        <div class="metric">
                            <strong>Disponível para Fazenda:</strong> ${Utils.formatCurrency(resultado.fazenda)}
                        </div>
                        <div class="metric">
                            <strong>Percentual do Patrimônio:</strong> ${Utils.formatPercentage(resultado.percentual)}
                        </div>
                        <div class="metric">
                            <strong>Status do Plano:</strong> 
                            <span class="status-${status}">${status.toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>💰 Breakdown dos Compromissos</h2>
                        <div class="metric">
                            <strong>Despesas Ana:</strong> ${Utils.formatCurrency(resultado.despesas)} 
                            (${((resultado.despesas/patrimonio)*100).toFixed(1)}% do patrimônio)
                        </div>
                        <div class="metric">
                            <strong>Renda dos Filhos:</strong> ${Utils.formatCurrency(resultado.filhos)} 
                            (${((resultado.filhos/patrimonio)*100).toFixed(1)}% do patrimônio)
                        </div>
                        <div class="metric">
                            <strong>Doações:</strong> ${Utils.formatCurrency(resultado.doacoes)} 
                            (${((resultado.doacoes/patrimonio)*100).toFixed(1)}% do patrimônio)
                        </div>
                        <div class="metric">
                            <strong>Total Compromissos:</strong> ${Utils.formatCurrency(resultado.total)} 
                            (${((resultado.total/patrimonio)*100).toFixed(1)}% do patrimônio)
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>📈 Análise de Sensibilidade</h2>
                        <p>Impacto da taxa de retorno no valor disponível para a fazenda:</p>
                        <table>
                            <thead>
                                <tr>
                                    <th>Taxa Real (%)</th>
                                    <th>Valor Fazenda</th>
                                    <th>% do Patrimônio</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sensibilidade.map(item => {
                                    const itemStatus = item.fazenda < 0 ? 'Inviável' : item.fazenda >= 10000000 ? 'Excelente' : 'Viável';
                                    const statusClass = item.fazenda < 0 ? 'status-critico' : item.fazenda >= 10000000 ? 'status-viavel' : 'status-atencao';
                                    return `
                                        <tr>
                                            <td><strong>${item.taxa}%</strong></td>
                                            <td><strong>${Utils.formatCurrency(item.fazenda)}</strong></td>
                                            <td>${Utils.formatPercentage(item.percentual)}</td>
                                            <td><span class="${statusClass}">${itemStatus}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h2>ℹ️ Metodologia</h2>
                        <p><strong>Premissas do Cálculo:</strong></p>
                        <ul>
                            <li>Expectativa de vida: ${document.getElementById('expectativaVida').value} anos</li>
                            <li>Taxa de retorno real: ${document.getElementById('taxaRetorno').value}% ao ano</li>
                            <li>Despesas mensais atuais: ${Utils.formatCurrency(parseInt(document.getElementById('despesasMensais').value))}</li>
                            <li>Renda para os filhos: R$ 150.000/mês (dos 65 aos 90 anos de Ana)</li>
                            <li>Doações: R$ 50.000/mês por 15 anos</li>
                        </ul>
                        <p><strong>Observação:</strong> Todos os valores são calculados em valor presente.</p>
                    </div>
                </body>
                </html>
                `;
                
                // Abrir em nova janela para impressão
                const printWindow = window.open('', '_blank');
                printWindow.document.write(reportHTML);
                printWindow.document.close();
                
                // Aguardar carregamento e abrir diálogo de impressão
                printWindow.onload = function() {
                    printWindow.print();
                };
                
                Utils.showNotification('Relatório HTML aberto! Use Ctrl+P para salvar como PDF', 'info', 8000);
                
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                Utils.showNotification('Erro ao gerar relatório', 'danger');
            }
        }

        function toggleFullscreen(chartId) {
            Utils.showNotification('Modo fullscreen em desenvolvimento', 'info');
        }

        // ================ MAIN CONTROLLER ================
        const DashboardController = {
            async initialize() {
                Debug.log('Initializing dashboard...');
                
                // Check libraries
                checkLibraries();
                
                // Setup events
                this.setupEvents();
                
                // Initialize sidebar controller
                SidebarController.init();
                
                // Load data
                await this.loadDashboard();
            },

            setupEvents() {
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadDashboard());
                
                // Controls with debounce
                const debouncedUpdate = Utils.debounce(() => this.loadDashboard(), 500);
                
                document.getElementById('taxaRetorno').addEventListener('input', (e) => {
                    document.getElementById('taxaDisplay').textContent = e.target.value + '%';
                    debouncedUpdate();
                });
                
                document.getElementById('expectativaVida').addEventListener('change', debouncedUpdate);
                document.getElementById('despesasMensais').addEventListener('input', debouncedUpdate);
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'r') {
                        e.preventDefault();
                        this.loadDashboard();
                    }
                });
            },

            async loadDashboard() {
                try {
                    Debug.log('Loading dashboard data...');
                    
                    // Show loading state
                    const refreshBtn = document.getElementById('refreshBtn');
                    refreshBtn.classList.add('loading');
                    refreshBtn.disabled = true;
                    
                    // Load data
                    AppState.currentData = await ApiClient.getDashboardData();
                    
                    // Update UI only if we're on dashboard page
                    if (AppState.currentPage === 'dashboard') {
                        UIManager.updateMetrics();
                        UIManager.updateAlerts();
                        UIManager.updateTable();
                        
                        // Create charts
                        ChartManager.createCharts();
                    }
                    
                    Utils.showNotification('Dashboard carregado!', 'success');
                    
                } catch (error) {
                    Debug.log('Error loading dashboard:', error);
                    Utils.showNotification('Erro ao carregar dados: ' + error.message, 'danger');
                } finally {
                    // Remove loading state
                    const refreshBtn = document.getElementById('refreshBtn');
                    refreshBtn.classList.remove('loading');
                    refreshBtn.disabled = false;
                }
            }
        };

        // ================ INITIALIZATION ================
        document.addEventListener('DOMContentLoaded', () => {
            Debug.log('DOM loaded, starting initialization...');
            DashboardController.initialize();
        });

        // Library check after 1 second and when window loads
        setTimeout(checkLibraries, 1000);
        window.addEventListener('load', checkLibraries);

        // ================ PERFORMANCE OPTIMIZATION ================
        
        // Intersection Observer for lazy loading charts
        const chartObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const chartId = entry.target.id;
                    Debug.log(`Chart ${chartId} is visible, loading...`);
                }
            });
        }, {
            threshold: 0.1
        });

        // Observe chart containers when they're available
        setTimeout(() => {
            const chartContainers = document.querySelectorAll('.chart-container canvas');
            chartContainers.forEach(container => {
                chartObserver.observe(container);
            });
        }, 1000);

        // ================ EASTER EGGS ================
        
        // Konami code easter egg
        let konamiCode = [];
        const konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'KeyB', 'KeyA'];
        
        document.addEventListener('keydown', (e) => {
            konamiCode.push(e.code);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (JSON.stringify(konamiCode) === JSON.stringify(konamiSequence)) {
                Utils.showNotification('🎉 Easter Egg ativado! Você encontrou o código Konami!', 'success', 10000);
                document.body.style.animation = 'rainbow 2s infinite';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 5000);
            }
        });

        // Rainbow animation for easter egg
        const style = document.createElement('style');
        style.textContent = `
            @keyframes rainbow {
                0% { filter: hue-rotate(0deg); }
                100% { filter: hue-rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>